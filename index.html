<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i H·ªçc: Ph√¢n T√≠ch D√≤ng Ch·∫£y D·ªØ Li·ªáu</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .flow-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            min-height: 120px;
            justify-content: center;
            text-align: center;
        }
        .data-flow-line {
            position: absolute;
            height: 3px;
            background-color: #3b82f6; /* Blue 500 */
            transition: all 0.5s ease-in-out;
            opacity: 0;
            z-index: 10;
        }
        .data-label {
            position: absolute;
            background-color: #1d4ed8; /* Blue 700 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: opacity 0.5s;
            opacity: 0;
            z-index: 20;
            white-space: nowrap;
        }
        .lesson-section {
            border-left: 4px solid #f97316; /* Orange 500 */
            padding-left: 1rem;
            margin-bottom: 2rem;
        }
        .diagram-box {
            background-color: #f0f9ff;
            border: 1px dashed #93c5fd;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center mb-8 bg-blue-600 text-white p-6 rounded-xl shadow-lg">
        <h1 class="text-3xl font-extrabold">PH√ÇN T√çCH D√íNG CH·∫¢Y D·ªÆ LI·ªÜU</h1>
        <p class="text-xl font-light mt-1">[IT5-Lesson 3.1] - Chu·∫©n b·ªã tr∆∞·ªõc khi ƒë·∫øn l·ªõp</p>
    </header>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl space-y-8">

        <!-- M·ª§C TI√äU B√ÄI H·ªåC -->
        <div class="lesson-section">
            <h2 class="text-2xl font-bold text-orange-600 mb-4">I. M·ª•c Ti√™u C√°c Ti·∫øt H·ªçc</h2>
            <ul class="list-disc list-inside text-gray-700 space-y-2 ml-4">
                <li><span class="font-bold">Nh·∫≠n di·ªán:</span> Li·ªát k√™ ƒë∆∞·ª£c c√°c ƒë·ªëi t∆∞·ª£ng (ng∆∞·ªùi, h·ªá th·ªëng) tham gia v√†o m·ªôt quy tr√¨nh.</li>
                <li><span class="font-bold">M√¥ t·∫£:</span> M√¥ t·∫£ ƒë∆∞·ª£c th√¥ng tin m·ªói ƒë·ªëi t∆∞·ª£ng <span class="font-bold">G·ª¨I</span> v√† <span class="font-bold">NH·∫¨N</span>.</li>
                <li><span class="font-bold">M√¥ h√¨nh h√≥a:</span> V·∫Ω ƒë∆∞·ª£c <span class="font-bold">S∆° ƒë·ªì D√≤ng Th√¥ng Tin (Data Flow Diagram)</span> ƒë∆°n gi·∫£n.</li>
                <li><span class="font-bold">Ph√¢n t√≠ch:</span> Ph√¢n t√≠ch ƒë∆∞·ª£c c√°c nh√°nh r·∫Ω v√† h·ªá qu·∫£ khi c√≥ l·ªói x·∫£y ra.</li>
            </ul>
        </div>

        <!-- HO·∫†T ƒê·ªòNG KH·ªûI ƒê·ªòNG & NH·∫¨N DI·ªÜN (TI·∫æT 3) -->
        <div class="lesson-section">
            <h2 class="text-2xl font-bold text-orange-600 mb-4">II. Kh√°m Ph√° Quy Tr√¨nh M∆∞·ª£n S√°ch</h2>
            <p class="text-gray-700 mb-4"><span class="font-bold">T√¨nh hu·ªëng:</span> B·∫°n Minh mu·ªën m∆∞·ª£n s√°ch. ƒê√¢y l√† chu·ªói ho·∫°t ƒë·ªông:</p>
            <ol class="list-decimal list-inside text-gray-700 space-y-1 ml-4 bg-gray-100 p-3 rounded-lg">
                <li>Minh ƒë∆∞a <span class="font-bold">Th·∫ª th∆∞ vi·ªán</span> cho c√¥ th·ªß th∆∞.</li>
                <li>C√¥ th·ªß th∆∞ d√πng m√°y qu√©t, <span class="font-bold">qu√©t M√£ s√°ch</span>.</li>
                <li>H·ªá th·ªëng m√°y t√≠nh <span class="font-bold">ki·ªÉm tra</span> th√¥ng tin m∆∞·ª£n v√† tr·∫°ng th√°i s√°ch.</li>
                <li>Minh <span class="font-bold">nh·∫≠n s√°ch</span>.</li>
            </ol>
            
            <h3 class="text-xl font-semibold text-blue-700 mt-4 mb-2">B·∫£ng D·ªØ Li·ªáu G·ª≠i - Nh·∫≠n (Ho·∫°t ƒë·ªông 1, Ti·∫øt 3)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒê·ªëi t∆∞·ª£ng</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">G·ª≠i th√¥ng tin g√¨? (Data Output)</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nh·∫≠n th√¥ng tin g√¨? (Data Input)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td class="px-3 py-2">H·ªçc sinh</td><td class="px-3 py-2">M√£ th·∫ª</td><td class="px-3 py-2">Tr·∫°ng th√°i m∆∞·ª£n (ƒê∆∞·ª£c/Kh√¥ng)</td></tr>
                        <tr><td class="px-3 py-2">Th·ªß th∆∞</td><td class="px-3 py-2">Y√™u c·∫ßu ki·ªÉm tra, M√£ s√°ch</td><td class="px-3 py-2">K·∫øt qu·∫£ t·ª´ H·ªá th·ªëng</td></tr>
                        <tr><td class="px-3 py-2">H·ªá th·ªëng</td><td class="px-3 py-2">Tr·∫°ng th√°i m∆∞·ª£n (K·∫øt qu·∫£)</td><td class="px-3 py-2">M√£ s√°ch, M√£ th·∫ª</td></tr>
                        <tr><td class="px-3 py-2">Kho s√°ch</td><td class="px-3 py-2">Tr·∫°ng th√°i s√°ch (C√≥/H·∫øt)</td><td class="px-3 py-2">Y√™u c·∫ßu ki·ªÉm tra</td></tr>
                    </tbody>
                </table>
            </div>
            <p class="text-sm italic text-gray-500 mt-2">üí° <span class="font-bold">K·∫øt lu·∫≠n:</span> D·ªØ li·ªáu di chuy·ªÉn li√™n t·ª•c, t·∫°o th√†nh <span class="font-bold">D√≤ng ch·∫£y D·ªØ li·ªáu (Data Flow)</span>.</p>
        </div>
        
        <!-- M√î PH·ªéNG D√íNG CH·∫¢Y D·ªÆ LI·ªÜU -->
        <div class="lesson-section bg-blue-50 p-6 rounded-lg">
            <h2 class="text-2xl font-bold text-orange-600 mb-4">III. M√¥ Ph·ªèng S∆° ƒë·ªì D√≤ng Th√¥ng Tin (DFD)</h2>
            
            <div class="diagram-box">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">S∆° ƒë·ªì quan h·ªá ƒë∆°n gi·∫£n (V√≠ d·ª• minh h·ªça):</h3>
                <p class="text-sm text-gray-700 mb-2">S∆° ƒë·ªì DFD s·ª≠ d·ª•ng h√¨nh h·ªôp cho ƒë·ªëi t∆∞·ª£ng v√† m≈©i t√™n cho d√≤ng d·ªØ li·ªáu:</p>
                <div class="text-center text-sm font-mono text-gray-900 bg-white p-2 rounded-md shadow-inner overflow-x-auto">
                    
                    <p class="mt-1"><span class="font-bold">H·ªçc sinh</span> ‚Üí M√£ th·∫ª/M√£ s√°ch ‚Üí <span class="font-bold">Th·ªß th∆∞</span> ‚Üí Y√™u c·∫ßu ki·ªÉm tra ‚Üí <span class="font-bold">H·ªá th·ªëng</span></p>
                </div>
            </div>

            <p class="text-gray-700 mt-4 mb-4">C√°c em h√£y nh·∫≠p M√£ th·∫ª v√† M√£ s√°ch ƒë·ªÉ xem m√¥ ph·ªèng <span class="font-bold">to√†n b·ªô</span> t·ª´ng b∆∞·ªõc d·ªØ li·ªáu di chuy·ªÉn gi·ªØa c√°c ƒë·ªëi t∆∞·ª£ng trong th∆∞ vi·ªán!</p>
            
            <!-- Kh·ªëi nh·∫≠p li·ªáu c·ªßa H·ªçc sinh -->
            <div class="mb-6 p-4 border border-blue-300 rounded-lg bg-white shadow-md">
                <h3 class="text-xl font-semibold text-blue-700 mb-3">1. H·ªçc Sinh (Ngu·ªìn d·ªØ li·ªáu)</h3>
                <div class="flex flex-col space-y-3 sm:flex-row sm:space-x-4 sm:space-y-0">
                    <input id="studentId" type="text" placeholder="Nh·∫≠p M√£ th·∫ª (VD: HS001)" value="HS001" class="p-2 border border-gray-300 rounded-md flex-grow focus:ring-blue-500 focus:border-blue-500">
                    <input id="bookId" type="text" placeholder="Nh·∫≠p M√£ s√°ch (VD: B001)" value="B001" class="p-2 border border-gray-300 rounded-md flex-grow focus:ring-blue-500 focus:border-blue-500">
                    <button onclick="startBorrowProcess()" id="borrowButton" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition duration-300 shadow-md font-medium">
                        B·∫Øt ƒë·∫ßu M√¥ ph·ªèng
                    </button>
                </div>
                <p class="text-sm italic text-gray-500 mt-2">Th·ª≠ nghi·ªám c√°c tr∆∞·ªùng h·ª£p: 
                    <span class="font-medium text-green-700">HS001 & B001 (Th√†nh c√¥ng)</span>, 
                    <span class="font-medium text-red-700">HS001 & B002 (S√°ch h·∫øt - R·∫Ω nh√°nh)</span>, 
                    <span class="font-medium text-red-700">HS999 & B001 (L·ªói ƒë·∫ßu v√†o - Ng·ª´ng)</span>.
                </p>
                <p id="errorMsg" class="text-red-500 mt-2 hidden">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ th·∫ª v√† M√£ s√°ch.</p>
            </div>

            <!-- S∆° ƒë·ªì D√≤ng ch·∫£y D·ªØ li·ªáu (DFD) -->
            <div class="relative grid grid-cols-2 gap-6 md:grid-cols-4 md:gap-8 justify-items-center mt-6" id="dataFlowContainer">

                <!-- ƒê·ªëi t∆∞·ª£ng 1: H·ªçc sinh -->
                <div id="entity-student" class="flow-item bg-blue-100 border-2 border-blue-500 col-span-1 md:col-span-1">
                    <span class="font-bold text-blue-800">H·ªåC SINH</span>
                    <p class="text-sm text-gray-600 mt-1">G·ª≠i: M√£ th·∫ª, M√£ s√°ch</p>
                </div>

                <!-- ƒê·ªëi t∆∞·ª£ng 2: Th·ªß th∆∞ -->
                <div id="entity-librarian" class="flow-item bg-yellow-100 border-2 border-yellow-500 col-span-1 md:col-span-1">
                    <span class="font-bold text-yellow-800">TH·ª¶ TH∆Ø</span>
                    <p class="text-sm text-gray-600 mt-1">X·ª≠ l√Ω & G·ª≠i y√™u c·∫ßu</p>
                </div>

                <!-- ƒê·ªëi t∆∞·ª£ng 3: H·ªá th·ªëng M√°y t√≠nh -->
                <div id="entity-system" class="flow-item bg-green-100 border-2 border-green-500 col-span-1 md:col-span-1">
                    <span class="font-bold text-green-800">H·ªÜ TH·ªêNG M√ÅY T√çNH</span>
                    <p class="text-sm text-gray-600 mt-1">Ki·ªÉm tra Tr·∫°ng th√°i M∆∞·ª£n</p>
                </div>

                <!-- ƒê·ªëi t∆∞·ª£ng 4: Kho s√°ch -->
                <div id="entity-book-stock" class="flow-item bg-red-100 border-2 border-red-500 col-span-1 md:col-span-1">
                    <span class="font-bold text-red-800">KHO S√ÅCH</span>
                    <p class="text-sm text-gray-600 mt-1">Ki·ªÉm tra M√£ s√°ch/S·ªë l∆∞·ª£ng</p>
                </div>

                <!-- V·ªã tr√≠ gi·∫£ l·∫≠p ƒë·ªÉ t·∫°o d√≤ng ch·∫£y ng∆∞·ª£c/k·∫øt qu·∫£ -->
                <div class="col-span-4 h-10 w-full"></div> 

                <!-- ƒê·ªëi t∆∞·ª£ng 5: K·∫øt qu·∫£ (Back to Student/H·ªçc sinh) -->
                <div id="entity-result" class="flow-item bg-indigo-100 border-2 border-indigo-500 col-span-4 md:col-span-4 w-full mx-auto">
                    <span class="font-bold text-indigo-800">K·∫æT QU·∫¢/PH·∫¢N H·ªíI</span>
                    <p id="resultText" class="text-sm mt-1 text-gray-600">Ch·ªù x·ª≠ l√Ω...</p>
                </div>

                <!-- C√°c D√≤ng D·ªØ li·ªáu (ƒê∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JS) -->
            </div>
        </div>

        <!-- HO·∫†T ƒê·ªòNG PH√ÇN T√çCH (TI·∫æT 4) -->
        <div class="lesson-section">
            <h2 class="text-2xl font-bold text-orange-600 mb-4">IV. Ph√¢n T√≠ch M·ªëi Quan H·ªá v√† Nh√°nh R·∫Ω (Chu·∫©n b·ªã cho Ti·∫øt 4)</h2>
            <div class="space-y-3 text-gray-700">
                <p><span class="font-bold">1. L·ªói ƒê·∫ßu V√†o (VD: M√£ th·∫ª sai):</span> D√≤ng th√¥ng tin s·∫Ω d·ª´ng l·∫°i s·ªõm v√† quay ng∆∞·ª£c l·∫°i. D·ªØ li·ªáu "Th√¥ng b√°o l·ªói" s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ª´ H·ªá th·ªëng ‚Üí Th·ªß th∆∞ ‚Üí H·ªçc sinh. (M√¥ ph·ªèng: D·ª´ng sau B∆∞·ªõc 2)</p>
                <p><span class="font-bold">2. Th√¥ng tin R·∫Ω Nh√°nh (VD: S√°ch ƒë√£ h·∫øt):</span> D√≤ng th√¥ng tin ƒëi h·∫øt chu tr√¨nh ki·ªÉm tra s√°ch (B∆∞·ªõc 3, 4) nh∆∞ng H·ªá th·ªëng tr·∫£ k·∫øt qu·∫£ t·ª´ ch·ªëi. (M√¥ ph·ªèng: D·ª´ng sau B∆∞·ªõc 4, ƒëi th·∫≥ng ƒë·∫øn Ph·∫£n h·ªìi Cu·ªëi c√πng)</p>
                <p><span class="font-bold">3. T·ªëi ∆∞u h√≥a:</span> ƒê·ªÉ m∆∞·ª£n s√°ch nhanh h∆°n, ch√∫ng ta c√≥ th·ªÉ t·ªëi ∆∞u b·∫±ng c√°ch cho H·ªçc sinh t·ª± qu√©t th·∫ª/s√°ch, b·ªè qua b∆∞·ªõc trung gian l√† Th·ªß th∆∞. <span class="font-bold">(HS ‚Üí H·ªá th·ªëng ‚Üí K·∫øt qu·∫£)</span></p>
            </div>
        </div>
        
        <!-- TR·ª¢ L√ù PH√ÇN T√çCH DFD TH√îNG MINH (GEMINI API FEATURE) -->
        <div class="lesson-section bg-gray-100 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-green-700 mb-4">V. Tr·ª£ L√Ω Ph√¢n T√≠ch DFD Th√¥ng Minh ‚ú®</h2>
            <p class="text-gray-700 mb-4">S·ª≠ d·ª•ng Tr·ª£ l√Ω AI ƒë·ªÉ ph√¢n t√≠ch c√°c t√¨nh hu·ªëng ph·ª©c t·∫°p ho·∫∑c ngo·∫°i l·ªá ch∆∞a ƒë∆∞·ª£c m√¥ ph·ªèng. H√£y nh·∫≠p v√†o m·ªôt k·ªãch b·∫£n th∆∞ vi·ªán b·∫•t k·ª≥!</p>
            
            <div class="flex flex-col space-y-3">
                <textarea id="scenarioInput" rows="3" placeholder="V√≠ d·ª•: Th·ªß th∆∞ b·ªã ·ªëm, ph·∫£i d√πng h·ªá th·ªëng t·ª± ƒë·ªông ƒë·ªÉ m∆∞·ª£n s√°ch. D√≤ng ch·∫£y d·ªØ li·ªáu s·∫Ω thay ƒë·ªïi nh∆∞ th·∫ø n√†o?" class="p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"></textarea>
                <button onclick="analyzeScenario()" id="analyzeButton" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition duration-300 shadow-lg font-medium">
                    Ph√¢n T√≠ch D√≤ng Ch·∫£y ‚ú®
                </button>
            </div>
            
            <div id="analysisResult" class="mt-4 p-4 bg-white border border-green-300 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-green-800 mb-2">K·∫øt Qu·∫£ Ph√¢n T√≠ch:</h3>
                <p id="analysisText" class="text-gray-800 whitespace-pre-wrap">Ch·ªù k·ªãch b·∫£n...</p>
                <p id="loadingIndicator" class="text-green-600 font-medium hidden">ƒêang ph√¢n t√≠ch...</p>
            </div>
        </div>
        <!-- END GEMINI API FEATURE -->

    </div>

    <footer class="text-center mt-8 text-gray-500 text-sm pb-4">
        <p>T√†i li·ªáu chu·∫©n b·ªã b√†i h·ªçc: Ph√¢n t√≠ch D√≤ng ch·∫£y D·ªØ li·ªáu (IT5-L3.1)</p>
    </footer>

    <script>
        // C·∫•u h√¨nh API c·ªßa Gemini
        const apiKey = ""; // API key s·∫Ω ƒë∆∞·ª£c cung c·∫•p trong m√¥i tr∆∞·ªùng Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // C·∫•u h√¨nh c√°c b∆∞·ªõc D√≤ng ch·∫£y D·ªØ li·ªáu (gi·ªØ nguy√™n cho m√¥ ph·ªèng tr·ª±c quan)
        const flowSteps = [
            { id: 1, from: 'entity-student', to: 'entity-librarian', data: 'M√£ th·∫ª & M√£ s√°ch', status: 'G·ª≠i D·ªØ li·ªáu' },
            { id: 2, from: 'entity-librarian', to: 'entity-system', data: 'Y√™u c·∫ßu ki·ªÉm tra', status: 'Y√™u c·∫ßu X·ª≠ l√Ω' },
            { id: 3, from: 'entity-system', to: 'entity-book-stock', data: 'Truy v·∫•n M√£ s√°ch', status: 'Truy v·∫•n Kho s√°ch' },
            { id: 4, from: 'entity-book-stock', to: 'entity-system', data: 'Tr·∫°ng th√°i S√°ch (C√≥/H·∫øt)', status: 'Ph·∫£n h·ªìi Tr·∫°ng th√°i' },
            { id: 5, from: 'entity-system', to: 'entity-librarian', data: 'K·∫øt qu·∫£ M∆∞·ª£n (ƒê∆∞·ª£c/Kh√¥ng)', status: 'G·ª≠i K·∫øt qu·∫£' },
            { id: 6, from: 'entity-librarian', to: 'entity-result', data: 'Giao s√°ch ho·∫∑c Th√¥ng b√°o', status: 'Ph·∫£n h·ªìi Cu·ªëi c√πng' }
        ];

        // D·ªØ li·ªáu gi·∫£ l·∫≠p
        const validStudentId = "HS001";
        const validBookId = "B001";
        const errorBookId = "B002"; // V√≠ d·ª• s√°ch ƒë√£ h·∫øt (R·∫Ω nh√°nh)
        const invalidStudentId = "HS999"; // V√≠ d·ª• l·ªói ƒë·∫ßu v√†o

        let isProcessing = false;
        let flowElements = []; // L∆∞u tr·ªØ c√°c ph·∫ßn t·ª≠ d√≤ng ch·∫£y ƒë√£ ƒë∆∞·ª£c t·∫°o

        // H√†m chung ƒë·ªÉ t·∫°o c√°c ph·∫ßn t·ª≠ D√≤ng ch·∫£y (ƒê∆∞·ªùng k·∫ª v√† Nh√£n)
        function createFlowElement(step) {
            const fromEl = document.getElementById(step.from);
            const toEl = document.getElementById(step.to === 'entity-result' ? 'entity-result' : step.to);

            if (!fromEl || !toEl) return null;

            const container = document.getElementById('dataFlowContainer');
            const containerRect = container.getBoundingClientRect();

            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();

            const line = document.createElement('div');
            line.className = 'data-flow-line';
            line.id = `line-${step.id}`;

            const label = document.createElement('div');
            label.className = 'data-label';
            label.textContent = step.data;
            label.id = `label-${step.id}`;

            let startX, startY;

            // T√≠nh to√°n v·ªã tr√≠ cho c√°c b∆∞·ªõc
            if (step.id >= 1 && step.id <= 4) {
                // D√≤ng ch·∫£y xu√¥i (H√†ng ngang)
                const margin = 10;
                let isReverse = step.id === 4; // B∆∞·ªõc 4 l√† Kho s√°ch -> H·ªá th·ªëng (ng∆∞·ª£c l·∫°i)
                
                let currentFromRect = isReverse ? toRect : fromRect;
                let currentToRect = isReverse ? fromRect : toRect;

                const y_offset = isReverse ? 35 : -35; // D·ªãch d√≤ng ng∆∞·ª£c xu·ªëng
                
                let endX;
                
                if (isReverse) {
                     // Reverse flow 4 (right to left)
                    startX = currentFromRect.left - containerRect.left - margin;
                    startY = currentFromRect.top + currentFromRect.height / 2 - containerRect.top + y_offset;
                    endX = currentToRect.right - containerRect.left + margin;
                } else {
                    // Forward flow 1, 2, 3 (left to right)
                    startX = currentFromRect.right - containerRect.left + margin;
                    startY = currentFromRect.top + currentFromRect.height / 2 - containerRect.top + y_offset;
                    endX = currentToRect.left - containerRect.left - margin;
                }

                const length = Math.abs(endX - startX);
                
                line.style.left = `${Math.min(startX, endX)}px`;
                line.style.top = `${startY}px`;
                line.style.width = `${length}px`;
                line.style.transform = `translateY(-50%)`;

                label.style.left = `${Math.min(startX, endX) + length / 2}px`;
                label.style.top = `${startY + (isReverse ? 15 : -15)}px`; // Label n·∫±m d∆∞·ªõi d√≤ng ng∆∞·ª£c, tr√™n d√≤ng xu√¥i
                label.style.transform = `translate(-50%, -50%)`;
            
            } else if (step.id === 5 || step.id === 6) {
                // D√≤ng ch·∫£y ng∆∞·ª£c/k·∫øt qu·∫£
                const y_offset = 35; // D·ªãch xu·ªëng so v·ªõi d√≤ng ƒëi xu√¥i
                const margin = 10;
                
                if (step.id === 5) {
                    // B∆∞·ªõc 5: H·ªá th·ªëng -> Th·ªß th∆∞ (H√†ng ngang ng∆∞·ª£c)
                    const systemRect = document.getElementById('entity-system').getBoundingClientRect();
                    const librarianRect = document.getElementById('entity-librarian').getBoundingClientRect();
                    
                    startX = systemRect.left - containerRect.left - margin;
                    startY = systemRect.top + systemRect.height / 2 - containerRect.top + y_offset;
                    let endX = librarianRect.right - containerRect.left + margin;

                    const length = endX - startX;
                    
                    line.style.left = `${startX}px`;
                    line.style.top = `${startY}px`;
                    line.style.width = `${length}px`;
                    line.style.transform = `translateY(-50%)`;

                    label.style.left = `${startX + length / 2}px`;
                    label.style.top = `${startY + 15}px`; // D·ªãch xu·ªëng d∆∞·ªõi ƒë∆∞·ªùng k·∫ª
                    label.style.transform = `translate(-50%, -50%)`;
                    
                } else if (step.id === 6) {
                    // B∆∞·ªõc 6: Th·ªß th∆∞ -> K·∫øt qu·∫£ (ƒêi xu·ªëng)
                    const librarianRect = document.getElementById('entity-librarian').getBoundingClientRect();
                    const resultRect = document.getElementById('entity-result').getBoundingClientRect();
                    
                    startX = librarianRect.left + librarianRect.width / 2 - containerRect.left;
                    startY = librarianRect.bottom - containerRect.top + 30; // ƒêi·ªÉm b·∫Øt ƒë·∫ßu d∆∞·ªõi TT
                    let endX = resultRect.left + resultRect.width / 2 - containerRect.left;
                    let endY = resultRect.top - containerRect.top - 10; // ƒêi·ªÉm d·ª´ng tr√™n KQ

                    const length = endY - startY;
                    
                    line.style.left = `${startX}px`;
                    line.style.top = `${startY}px`;
                    line.style.height = `${length}px`;
                    line.style.width = `3px`; // ƒê∆∞·ªùng k·∫ª d·ªçc
                    line.style.transform = `translateX(-50%)`;

                    label.style.left = `${startX + 10}px`; // D·ªãch sang ph·∫£i m·ªôt ch√∫t
                    label.style.top = `${startY + length / 2}px`;
                    label.style.transform = `translate(-50%, -50%)`;
                }
            }

            // Th√™m c√°c ph·∫ßn t·ª≠ v√†o container
            container.appendChild(line);
            container.appendChild(label);
            return { line, label };
        }

        // H√†m reset giao di·ªán
        function resetFlow() {
            // X√≥a c√°c d√≤ng ch·∫£y c≈©
            document.querySelectorAll('.data-flow-line, .data-label').forEach(el => el.remove());
            
            // T·∫Øt highlight
            document.querySelectorAll('.flow-item').forEach(el => {
                el.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105', 'ring-red-500');
            });
            
            // Reset text k·∫øt qu·∫£
            document.getElementById('resultText').textContent = "Ch·ªù x·ª≠ l√Ω...";
            document.getElementById('resultText').classList.remove('text-green-600', 'text-red-600');
            document.getElementById('resultText').classList.add('text-gray-600');

            // T·∫°o l·∫°i flow elements (ƒë·∫£m b·∫£o v·ªã tr√≠ ch√≠nh x√°c)
            flowElements = flowSteps.map(createFlowElement).filter(e => e !== null);
        }

        // H√†m m√¥ ph·ªèng b∆∞·ªõc cu·ªëi c√πng (cho c·∫£ th√†nh c√¥ng v√† th·∫•t b·∫°i)
        async function simulateFinalResult(resultMsg, resultClass) {
            const finalStep = flowSteps[5]; // B∆∞·ªõc 6 (index 5)
            const { line, label } = flowElements[5]; 
            const librarianEl = document.getElementById(finalStep.from);
            const resultEl = document.getElementById(finalStep.to);

            // B∆∞·ªõc 6: Th·ªß th∆∞ -> K·∫øt qu·∫£
            librarianEl.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            line.style.opacity = 1;
            label.style.opacity = 1;
            label.textContent = "Th√¥ng b√°o k·∫øt qu·∫£";
            
            resultEl.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            // C·∫≠p nh·∫≠t k·∫øt qu·∫£ cu·ªëi c√πng
            document.getElementById('resultText').textContent = resultMsg;
            document.getElementById('resultText').classList.remove('text-gray-600');
            document.getElementById('resultText').classList.add(resultClass);

            // K·∫øt th√∫c
            librarianEl.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');
            resultEl.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');

            isProcessing = false;
            document.getElementById('borrowButton').disabled = false;
            document.getElementById('borrowButton').textContent = "B·∫Øt ƒë·∫ßu M√¥ ph·ªèng l·∫°i";
        }


        // H√†m m√¥ ph·ªèng t·ª´ng b∆∞·ªõc
        async function simulateStep(stepIndex, bookId) {
            if (isProcessing === false) return;

            const step = flowSteps[stepIndex];
            const { line, label } = flowElements[stepIndex];
            const entity = document.getElementById(step.from);
            const nextEntity = document.getElementById(step.to === 'entity-result' ? 'entity-result' : step.to);

            // 1. Highlight ƒë·ªëi t∆∞·ª£ng g·ª≠i
            entity.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');

            await new Promise(resolve => setTimeout(resolve, 500));

            // 2. Hi·ªÉn th·ªã d√≤ng ch·∫£y
            line.style.opacity = 1;
            label.style.opacity = 1;

            // 3. Highlight ƒë·ªëi t∆∞·ª£ng nh·∫≠n (ti·∫øp theo)
            nextEntity.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');

            await new Promise(resolve => setTimeout(resolve, 1000));

            // 4. Reset highlight c·ªßa ƒë·ªëi t∆∞·ª£ng g·ª≠i
            entity.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');
            
            // --- X·ª¨ L√ù R·∫º NH√ÅNH T·∫†I ƒê√ÇY ---
            
            // K·ªãch b·∫£n 1: L·ªói ƒê·∫ßu V√†o (Ng·ª´ng sau B∆∞·ªõc 2 - TT -> HT)
            if (stepIndex === 1 && bookId !== validBookId && bookId !== errorBookId) {
                nextEntity.classList.add('ring-4', 'ring-red-500', 'ring-opacity-75', 'scale-105'); // Highlight L·ªói
                await new Promise(resolve => setTimeout(resolve, 500));
                nextEntity.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');
                
                await simulateFinalResult(
                    "TH·∫§T B·∫†I (L·ªñI ƒê·∫¶U V√ÄO): H·ªá th·ªëng tr·∫£ v·ªÅ l·ªói M√£ th·∫ª/s√°ch kh√¥ng h·ª£p l·ªá.", 
                    'text-red-600'
                );
                return; // D·ª´ng lu·ªìng th√†nh c√¥ng
            }

            // K·ªãch b·∫£n 2: S√°ch ƒê√£ H·∫øt (Ng·ª´ng sau B∆∞·ªõc 4 - KS -> HT)
            if (stepIndex === 3 && bookId === errorBookId) {
                // ƒê√£ ho√†n th√†nh B∆∞·ªõc 4 (Kho s√°ch -> H·ªá th·ªëng), nh∆∞ng H·ªá th·ªëng t·ª´ ch·ªëi
                nextEntity.classList.add('ring-4', 'ring-red-500', 'ring-opacity-75', 'scale-105'); // Highlight HT t·ª´ ch·ªëi
                await new Promise(resolve => setTimeout(resolve, 500));
                nextEntity.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-75', 'scale-105');

                await simulateFinalResult(
                    "TH·∫§T B·∫†I (R·∫º NH√ÅNH): S√°ch n√†y ƒê√É H·∫æT HO·∫∂C KH√îNG C√ì trong kho!", 
                    'text-red-600'
                );
                return; // D·ª´ng lu·ªìng th√†nh c√¥ng
            }

            // K·ªãch b·∫£n 3: Th√†nh C√¥ng (Ti·∫øp t·ª•c ƒë·∫øn h·∫øt)
            if (stepIndex < flowSteps.length - 1) {
                simulateStep(stepIndex + 1, bookId);
            } else {
                // B∆∞·ªõc cu·ªëi c√πng c·ªßa lu·ªìng th√†nh c√¥ng (Step 6)
                await simulateFinalResult(
                    "TH√ÄNH C√îNG: S√°ch ƒë∆∞·ª£c ch·∫•p nh·∫≠n cho m∆∞·ª£n!", 
                    'text-green-600'
                );
            }
        }

        // H√†m b·∫Øt ƒë·∫ßu quy tr√¨nh
        function startBorrowProcess() {
            if (isProcessing) return;

            const studentId = document.getElementById('studentId').value.trim();
            const bookId = document.getElementById('bookId').value.trim();
            const errorMsg = document.getElementById('errorMsg');

            if (!studentId || !bookId) {
                errorMsg.classList.remove('hidden');
                return;
            } else {
                errorMsg.classList.add('hidden');
            }

            isProcessing = true;
            document.getElementById('borrowButton').disabled = true;
            document.getElementById('borrowButton').textContent = "ƒêang M√¥ ph·ªèng...";

            resetFlow();
            
            // X·ª≠ l√Ω L·ªói ƒê·∫ßu V√†o ngay t·ª´ ƒë·∫ßu
            if (studentId !== validStudentId && studentId !== invalidStudentId) {
                 // N·∫øu m√£ th·∫ª kh√¥ng h·ª£p l·ªá, x·ª≠ l√Ω n√≥ nh∆∞ m·ªôt l·ªói ƒë·∫ßu v√†o (d·ª´ng s·ªõm)
                 simulateStep(0, "InvalidInput"); // Ch·ªâ ch·∫°y b∆∞·ªõc 1 v√† 2, sau ƒë√≥ ng·∫Øt
            } else if (studentId === invalidStudentId || studentId === validStudentId) {
                 // M√£ th·∫ª h·ª£p l·ªá (ho·∫∑c gi·∫£ l·∫≠p h·ª£p l·ªá ƒë·ªÉ ki·ªÉm tra s√°ch h·∫øt)
                 simulateStep(0, bookId);
            }
        }
        
        // --- GEMINI API INTEGRATION FUNCTION ---

        // H√†m g·ªçi API c·ªßa Gemini ƒë·ªÉ ph√¢n t√≠ch k·ªãch b·∫£n
        async function analyzeScenario() {
            const inputEl = document.getElementById('scenarioInput');
            const resultDiv = document.getElementById('analysisResult');
            const resultTextEl = document.getElementById('analysisText');
            const loadingEl = document.getElementById('loadingIndicator');
            const analyzeBtn = document.getElementById('analyzeButton');

            const userQuery = inputEl.value.trim();

            if (userQuery.length < 10) {
                resultTextEl.textContent = "Vui l√≤ng nh·∫≠p k·ªãch b·∫£n chi ti·∫øt h∆°n (t·ªëi thi·ªÉu 10 k√Ω t·ª±).";
                resultDiv.classList.remove('hidden');
                return;
            }

            // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
            resultDiv.classList.remove('hidden');
            resultTextEl.textContent = "";
            loadingEl.classList.remove('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = "ƒêang Ph√¢n T√≠ch...";

            const systemPrompt = `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch d√≤ng ch·∫£y d·ªØ li·ªáu (DFD) trong lƒ©nh v·ª±c th∆∞ vi·ªán. Ph√¢n t√≠ch k·ªãch b·∫£n sau trong ng·ªØ c·∫£nh quy tr√¨nh m∆∞·ª£n s√°ch.

Y√™u c·∫ßu:
1. X√°c ƒë·ªãnh D√≤ng ch·∫£y D·ªØ li·ªáu m·ªõi (Entity -> Data -> Entity).
2. X√°c ƒë·ªãnh ƒëi·ªÉm r·∫Ω nh√°nh ho·∫∑c l·ªói (n·∫øu c√≥).
3. ƒê∆∞a ra K·∫øt qu·∫£/H·ªá qu·∫£ cu·ªëi c√πng.
4. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, d∆∞·ªõi d·∫°ng danh s√°ch g·∫°ch ƒë·∫ßu d√≤ng ng·∫Øn g·ªçn.`;

            const fullPrompt = `K·ªãch b·∫£n m∆∞·ª£n s√°ch c·∫ßn ph√¢n t√≠ch: "${userQuery}"
C√°c ƒë·ªëi t∆∞·ª£ng c√≥ s·∫µn trong h·ªá th·ªëng: H·ªçc sinh, Th·ªß th∆∞, H·ªá th·ªëng M√°y t√≠nh, Kho s√°ch.`;

            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            let maxRetries = 5;
            let delay = 1000; // 1 second

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        resultTextEl.textContent = candidate.content.parts[0].text;
                        break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                    } else {
                        resultTextEl.textContent = "L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI.";
                        break;
                    }
                } catch (error) {
                    console.error("L·ªói g·ªçi API:", error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        resultTextEl.textContent = `L·ªói h·ªá th·ªëng: Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c ph√¢n t√≠ch k·ªãch b·∫£n sau ${maxRetries} l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i.`;
                    }
                }
            }
            
            // K·∫øt th√∫c tr·∫°ng th√°i t·∫£i
            loadingEl.classList.add('hidden');
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = "Ph√¢n T√≠ch D√≤ng Ch·∫£y ‚ú®";
        }

        // ƒê·∫£m b·∫£o t·∫°o c√°c d√≤ng ch·∫£y khi trang ƒë√£ t·∫£i xong (ƒê·ªÉ c√≥ v·ªã tr√≠ ch√≠nh x√°c)
        window.onload = () => {
            resetFlow();
        };

    </script>
</body>
</html>